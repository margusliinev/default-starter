---
description: NestJS Backend Standards & Conventions
globs: **/*.ts
alwaysApply: false
---

# NestJS Backend Conventions

## Critical Implementation Guidelines

1. **Naming Conventions**:
   - **Files**: Kebab-case (`user-profile.service.ts`)
   - **Classes**: PascalCase (`UserProfileService`)
   - **Interfaces/Types**: PascalCase (`OAuthUserInfo`)
   - **Variables/Functions**: CamelCase (`findUserById`)
   - **Database Columns**: Snake_case (`email_verified_at`)
2. **No `any` Type**: Strictly forbidden. Use `unknown` or specific types.
3. **No Explicit Return Types**: Omit unless absolutely necessary for clarity.
4. **Concise Comments**: Only where logic is complex; keep short.
5. **Concision**: Sacrifice grammar for brevity in all communications.

## Tech Stack

| Category       | Technology                                       |
| -------------- | ------------------------------------------------ |
| Framework      | NestJS 11                                        |
| Database       | PostgreSQL 18                                    |
| ORM            | TypeORM                                          |
| Language       | TypeScript                                       |
| Validation     | class-validator, class-transformer               |
| Auth           | Custom session-based + OAuth (Google, GitHub)    |
| Password Hash  | Argon2 (@node-rs/argon2)                         |
| Crypto         | @oslojs/crypto, @oslojs/encoding                 |
| Testing        | Jest 30 with SWC                                 |
| CLI            | nest-commander                                   |
| Scheduling     | @nestjs/schedule                                 |
| Rate Limiting  | @nestjs/throttler                                |
| Security       | helmet, cookie-parser, signed cookies            |
| Package Mgr    | npm                                              |

## Project Structure

```
├── db/                   # TypeORM migrations
├── compose.yml           # Docker: PostgreSQL
├── nest-cli.json         # NestJS CLI config
├── tsconfig.json         # TypeScript config
└── src/
    ├── cli/              # CLI commands
    ├── common/           # Shared utilities
    ├── crons/            # Scheduled tasks
    ├── features/         # Feature modules
    ├── app.module.ts     # Root module, global guards
    ├── cli.ts            # CLI entrypoint
    └── main.ts           # HTTP server entrypoint
```

### Common (`src/common/`)

Shared utilities across features. Not a NestJS module—just organized exports.

| Folder         | Purpose                                                      |
| -------------- | ------------------------------------------------------------ |
| `config/`      | Env validation + TypeORM DataSource for migrations           |
| `constants/`   | Shared constants (Argon2 options, etc.)                      |
| `decorators/`  | `@Auth()` (extract session), `@Public()` (bypass auth)       |
| `enums/`       | `Environment`, `Provider` enums                              |
| `filters/`     | Global exception filter (CatchAllFilter)                     |
| `interceptors/`| Logging, Timeout (30s), Transform (response wrapper)         |
| `testing/`     | TestModule, fixtures, DTO validation helpers                 |
| `types/`       | Type declarations (Express.Request extension)                |

### Features (`src/features/`)

Vertical slice architecture. Each feature is self-contained.

```
src/features/{feature}/
├── dto/                     # Request/response DTOs
├── entities/                # TypeORM entities
├── tests/                   # Unit/integration tests
├── {feature}.controller.ts  # HTTP handlers
├── {feature}.service.ts     # Business logic
├── {feature}.module.ts      # Module definition
└── {feature}.guard.ts       # Feature-specific guards (optional)
```

## Component Patterns

### Controllers

- Define routes and HTTP methods
- Use DTOs for request validation
- Delegate all logic to services
- Use `@Auth()` to get session, `@Public()` for public routes
- Never contain business logic or direct DB access

### Services

- Contain all business rules
- Interact with DB via TypeORM repositories
- Accept optional `EntityManager` param for transaction support via `getRepository()` helper
- Throw standard NestJS exceptions
- Never return HTTP-specific objects

### DTOs

- Use class-validator decorators with custom error messages
- Order decorators from most to least specific
- Use class-transformer when needed (`@Type()`, `@Transform()`)

### Entities

- Use TypeORM decorators
- Snake_case for column names (`name: 'created_at'`)
- Use `timestamptz` for all date columns
- Use `uuidv7()` for primary keys (via migration)

## Global Setup

### Bootstrap (`main.ts`)

- **Logger**: `['log', 'warn', 'error']`
- **CORS**: Enabled with `credentials: true`
- **Security**: Helmet, signed cookies, compression
- **Global Prefix**: `/api`
- **ValidationPipe**: `whitelist`, `transform`, `forbidNonWhitelisted`, custom `exceptionFactory`
- **Interceptors**: Logging → Timeout (30s) → Transform → ClassSerializer
- **Filters**: CatchAllFilter

### Global Guards (`app.module.ts`)

- **ThrottlerGuard**: Rate limiting (100 req/min)
- **AuthGuard**: Session-based authentication

### Response Format

- **Success**: `{ success: true, data: ... }`
- **Error**: `{ success: false, message: '...', errors?: { field: 'message' } }`

## Environment Variables

Required in `.env`:

| Variable               | Description                          |
| ---------------------- | ------------------------------------ |
| `PORT`                 | Server port                          |
| `NODE_ENV`             | development, production, test        |
| `FRONTEND_URL`         | CORS origin                          |
| `COOKIE_SECRET`        | Min 32 chars for signed cookies      |
| `DATABASE_URL`         | PostgreSQL connection string         |
| `GOOGLE_CLIENT_ID`     | OAuth client ID                      |
| `GOOGLE_CLIENT_SECRET` | OAuth client secret                  |
| `GOOGLE_CALLBACK_URL`  | OAuth callback URL                   |
| `GITHUB_CLIENT_ID`     | OAuth client ID                      |
| `GITHUB_CLIENT_SECRET` | OAuth client secret                  |
| `GITHUB_CALLBACK_URL`  | OAuth callback URL                   |

## npm Scripts

| Script                              | Description                           |
| ----------------------------------- | ------------------------------------- |
| `npm run dev`                       | Start dev server with watch mode      |
| `npm run build`                     | Build for production                  |
| `npm run start`                     | Run production build                  |
| `npm run format`                    | Format code with Prettier             |
| `npm run test`                      | Run tests with Jest                   |
| `npm run cli`                       | Run CLI (shows help)                  |
| `npm run cli db:seed`               | Seed database with test user          |
| `npm run migration:create --name=X` | Create new migration                  |
| `npm run migration:run`             | Run pending migrations                |
| `npm run migration:revert`          | Revert last migration                 |
| `npm run migration:show`            | Show migration status                 |

## Docker

Start databases: `docker compose up -d`

- **db**: Development database (port 5432)
- **db_test**: Test database (port 5433)

## Testing

- **Framework**: Jest 30 with SWC
- **Test files**: `*.spec.ts` in `tests/` folders within features
- **TestModule**: Pre-configured module in `common/testing/` (uses `.env.test`, `synchronize: true`)
- **Fixtures**: Factory functions for test data (`createUserDto()`, `createMockUser()`, etc.)
- **Validation helpers**: `validateDto()`, `expectValidationError()`, `describeValidationRules()`

## Authentication

- **Session-based**: Signed HTTP-only cookie (`auth-session`)
- **Session duration**: 30 days, auto-renews within 15 days of expiry
- **OAuth**: Google/GitHub with state cookie for CSRF protection
- **AuthGuard**: Global guard validates session on every request
- **@Public()**: Decorator to bypass auth on specific routes

## Creating a New Feature

1. Create `src/features/{name}/` directory
2. Define entity in `entities/`
3. Create DTOs in `dto/`
4. Implement service in `{name}.service.ts`
5. Create controller in `{name}.controller.ts`
6. Define module in `{name}.module.ts`
7. Import module in `app.module.ts`
8. Create migration if needed: `npm run migration:create --name=Create{Name}Table`
9. Add tests in `tests/`
